From 5d9b5515240e185313a4079c731b3ed33aa4b551 Mon Sep 17 00:00:00 2001
From: MikeWang000000 <mikewang000000@gmail.com>
Date: Thu, 23 Jun 2022 19:20:17 +0800
Subject: [PATCH] Replace deprecated FFmpeg APIs to support FFmpeg 5.x

---
 src/spek-audio.cc | 60 +++++++++++++++++++++++------------------------
 1 file changed, 30 insertions(+), 30 deletions(-)

diff --git a/src/spek-audio.cc b/src/spek-audio.cc
index 375716e..31bce16 100644
--- a/src/spek-audio.cc
+++ b/src/spek-audio.cc
@@ -46,7 +46,7 @@ class AudioFileImpl : public AudioFile
     int channels;
     double duration;
 
-    AVPacket packet;
+    AVPacket *packet;
     int offset;
     AVFrame *frame;
     int buffer_len;
@@ -99,7 +99,7 @@ std::unique_ptr<AudioFile> Audio::open(const std::string& file_name, int stream)
 
     AVStream *avstream = nullptr;
     AVCodecParameters *codecpar = nullptr;
-    AVCodec *codec = nullptr;
+    const AVCodec *codec = nullptr;
     if (!error) {
         avstream = format_context->streams[audio_stream];
         codecpar = avstream->codecpar;
@@ -156,7 +156,7 @@ std::unique_ptr<AudioFile> Audio::open(const std::string& file_name, int stream)
         if (bits_per_sample) {
             bit_rate = 0;
         }
-        channels = codecpar->channels;
+        channels = codecpar->ch_layout.nb_channels;
 
         if (avstream->duration != AV_NOPTS_VALUE) {
             duration = avstream->duration * av_q2d(avstream->time_base);
@@ -214,9 +214,9 @@ AudioFileImpl::AudioFileImpl(
     sample_rate(sample_rate),
     bits_per_sample(bits_per_sample), streams(streams), channels(channels), duration(duration)
 {
-    av_init_packet(&this->packet);
-    this->packet.data = nullptr;
-    this->packet.size = 0;
+    this->packet = av_packet_alloc();
+    this->packet->data = nullptr;
+    this->packet->size = 0;
     this->offset = 0;
     this->frame = av_frame_alloc();
     this->buffer_len = 0;
@@ -234,11 +234,11 @@ AudioFileImpl::~AudioFileImpl()
     if (this->frame) {
         av_frame_free(&this->frame);
     }
-    if (this->packet.data) {
-        this->packet.data -= this->offset;
-        this->packet.size += this->offset;
+    if (this->packet->data) {
+        this->packet->data -= this->offset;
+        this->packet->size += this->offset;
         this->offset = 0;
-        av_packet_unref(&this->packet);
+        av_packet_unref(this->packet);
     }
     if (this->format_context) {
         avformat_close_input(&this->format_context);
@@ -262,23 +262,23 @@ int AudioFileImpl::read()
     }
 
     for (;;) {
-        while (this->packet.size > 0) {
+        while (this->packet->size > 0) {
             av_frame_unref(this->frame);
-            int got_frame = 0;
-            int len = avcodec_decode_audio4(
-                this->codec_context, this->frame, &got_frame, &this->packet
-            );
-            if (len < 0) {
-                // Error, skip the frame.
+            int ret;
+            ret = avcodec_send_packet(this->codec_context, this->packet);
+            if (ret < 0) {
+                // Error sending a packet for decoding, skip the frame.
                 break;
             }
-            this->packet.data += len;
-            this->packet.size -= len;
-            this->offset += len;
-            if (!got_frame) {
-                // No data yet, get more frames.
-                continue;
+            ret = avcodec_receive_frame(this->codec_context, this->frame);
+            if (ret < 0 && ret != AVERROR(EAGAIN) && ret != AVERROR_EOF) {
+                // Error during decoding, skip the frame.
+                break;
             }
+            int len = this->packet->size;
+            this->packet->data += len;
+            this->packet->size -= len;
+            this->offset += len;
             // We have data, return it and come back for more later.
             int samples = this->frame->nb_samples;
             int channels = this->channels;
@@ -333,19 +333,19 @@ int AudioFileImpl::read()
             }
             return buffer_len;
         }
-        if (this->packet.data) {
-            this->packet.data -= this->offset;
-            this->packet.size += this->offset;
+        if (this->packet->data) {
+            this->packet->data -= this->offset;
+            this->packet->size += this->offset;
             this->offset = 0;
-            av_packet_unref(&this->packet);
+            av_packet_unref(this->packet);
         }
 
         int res = 0;
-        while ((res = av_read_frame(this->format_context, &this->packet)) >= 0) {
-            if (this->packet.stream_index == this->audio_stream) {
+        while ((res = av_read_frame(this->format_context, this->packet)) >= 0) {
+            if (this->packet->stream_index == this->audio_stream) {
                 break;
             }
-            av_packet_unref(&this->packet);
+            av_packet_unref(this->packet);
         }
         if (res < 0) {
             // End of file or error.
