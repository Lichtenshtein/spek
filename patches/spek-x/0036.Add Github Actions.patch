From 2e4c9302db57430205ca4dfcfefa3fc5a3f95e7c Mon Sep 17 00:00:00 2001
From: MikeWang000000 <mikewang000000@gmail.com>
Date: Wed, 25 Jan 2023 22:53:12 +0800
Subject: [PATCH] Add Github Actions

---
 .github/workflows/ci.yml       | 114 +++++++++++++++++++++++++++++++++
 dist/debian/control.ci         |   9 +++
 dist/osx/cross/bundle.sh       |  81 +++++++++++++++++++++++
 dist/osx/cross/install_deps.sh |  79 +++++++++++++++++++++++
 4 files changed, 283 insertions(+)
 create mode 100644 .github/workflows/ci.yml
 create mode 100644 dist/debian/control.ci
 create mode 100755 dist/osx/cross/bundle.sh
 create mode 100755 dist/osx/cross/install_deps.sh

diff --git a/.github/workflows/ci.yml b/.github/workflows/ci.yml
new file mode 100644
index 0000000..492e76d
--- /dev/null
+++ b/.github/workflows/ci.yml
@@ -0,0 +1,114 @@
+name: CI
+run-name: CI
+on: [push, pull_request, workflow_dispatch]
+env: 
+  HOMEBREW_NO_ANALYTICS: 1
+  HOMEBREW_NO_AUTO_UPDATE: 1
+  HOMEBREW_NO_INSTALL_CLEANUP: 1
+jobs:
+  Build-Debian-x86_64:
+    name: Build Spek-X (Debian, x86_64)
+    runs-on: ubuntu-22.04
+    steps:
+      - name: Check out repository code
+        uses: actions/checkout@v3
+      - name: Install dependencies
+        run: |
+          sudo sed -i 's/jammy/kinetic/g' /etc/apt/sources.list
+          sudo apt update
+          sudo apt install -y intltool libwxgtk3.2-dev wx-common libavcodec-dev libavformat-dev
+      - name: Compile and bundle application
+        run: |
+          cd '${{ github.workspace }}'
+          mkdir -p ./dist/debian/spek-x/usr ./dist/debian/spek-x/DEBIAN
+          ./autogen.sh --prefix="$(realpath ./dist/debian/spek-x/usr)"
+          make -j2 && make install
+          cp ./dist/debian/control.ci ./dist/debian/spek-x/DEBIAN/control
+          dpkg-deb --build dist/debian/spek-x
+      - name: Archive production artifacts
+        uses: actions/upload-artifact@v3
+        with:
+          name: Spek-X (Debian, x86_64)
+          path: ${{ github.workspace }}/dist/debian/spek-x.deb
+
+  Build-Windows-x64:
+    name: Build Spek-X (Windows, x64)
+    runs-on: windows-2022
+    defaults:
+      run:
+        shell: msys2 {0}
+    steps:
+      - name: Check out repository code
+        uses: actions/checkout@v3
+      - name: Setup MSYS2
+        uses: msys2/setup-msys2@v2
+        with:
+          msystem: mingw64
+      - name: Install dependencies
+        run: |
+          cd '${{ github.workspace }}' && ./dist/win/install_deps.sh
+      - name: Compile and bundle application
+        run: |
+          cd '${{ github.workspace }}' && ./dist/win/bundle.sh
+      - name: Archive production artifacts
+        uses: actions/upload-artifact@v3
+        with:
+          name: Spek-X (Windows, x64)
+          path: ${{ github.workspace }}/dist/win/Spek/Spek.zip
+
+  Build-macOS-Intel:
+    name: Build Spek-X (macOS, Intel)
+    runs-on: macos-12
+    steps:
+      - name: Check out repository code
+        uses: actions/checkout@v3
+      - name: Install dependencies
+        run: |
+          eval "$(brew shellenv)"
+          brew unlink perl
+          cd '${{ github.workspace }}' && ./dist/osx/install_deps.sh
+      - name: Compile and bundle application
+        run: |
+          eval "$(brew shellenv)"
+          cd '${{ github.workspace }}' && ./dist/osx/bundle.sh
+      - name: Archive production artifacts
+        uses: actions/upload-artifact@v3
+        with:
+          name: Spek-X (macOS, Intel)
+          path: ${{ github.workspace }}/dist/osx/Spek.tgz
+
+  Build-macOS-AppleSilicon:
+    name: Build Spek-X (macOS, Apple Silicon)
+    runs-on: macos-12
+    steps:
+      - name: Check out repository code
+        uses: actions/checkout@v3
+      - name: Install dependencies
+        run: |
+          eval "$(brew shellenv)"
+          brew unlink perl
+          cd '${{ github.workspace }}' && ./dist/osx/cross/install_deps.sh i_am_ci
+      - name: Compile and bundle application
+        run: |
+          eval "$(brew shellenv)"
+          cd '${{ github.workspace }}' && ./dist/osx/cross/bundle.sh i_am_ci
+      - name: Archive production artifacts
+        uses: actions/upload-artifact@v3
+        with:
+          name: Spek-X (macOS, Apple Silicon)
+          path: ${{ github.workspace }}/dist/osx/Spek.tgz
+
+  Unit-Test:
+    name: Unit Tests
+    runs-on: ubuntu-22.04
+    steps:
+      - name: Check out repository code
+        uses: actions/checkout@v3
+      - name: Install dependencies
+        run: |
+          sudo sed -i 's/jammy/kinetic/g' /etc/apt/sources.list
+          sudo apt update
+          sudo apt install -y intltool libwxgtk3.2-dev wx-common libavcodec-dev libavformat-dev
+      - name: Run tests
+        run: |
+          ./autogen.sh && make check
diff --git a/dist/debian/control.ci b/dist/debian/control.ci
new file mode 100644
index 0000000..2fabc44
--- /dev/null
+++ b/dist/debian/control.ci
@@ -0,0 +1,9 @@
+Package: spek-x
+Version: 0.0-testing
+Section: sound
+Priority: optional
+Maintainer: MikeWang000000 <mikewang000000@gmail.com>
+Homepage: https://github.com/MikeWang000000/spek-X
+Architecture: amd64
+Depends: libavcodec59, libavformat59, libavutil57, libc6, libgcc-s1, libstdc++6, libwxbase3.2-0, libwxgtk3.2-0
+Description: Spek-X helps to analyse your audio files by showing their spectrogram.
diff --git a/dist/osx/cross/bundle.sh b/dist/osx/cross/bundle.sh
new file mode 100755
index 0000000..ded6996
--- /dev/null
+++ b/dist/osx/cross/bundle.sh
@@ -0,0 +1,81 @@
+#!/bin/bash
+
+if [ "$1" != "i_am_ci" ]
+then
+    cat << EOF
+
+!!! DO NOT RUN THIS SCRIPT ON YOUR COMPUTER !!!
+-----------------------------------------------
+This script is used to build Spek-X Apple Silicon packages on Intel macOS CI.
+It will break your dependencies if not executed in a container.
+
+EOF
+    exit 1
+fi
+
+LANGUAGES="bs ca cs da de el eo es fi fr gl he hu id it ja ko lv nb nl pl pt_BR ru sk sr@latin sv th tr uk vi zh_CN zh_TW"
+LOCALEDIR="/usr/local/share/locale/"
+[ ! -d "$LOCALEDIR" ] && [ -d "$HOMEBREW_PREFIX/share/locale/" ] && LOCALEDIR="$HOMEBREW_PREFIX/share/locale/"
+
+cd $(dirname $0)/../../..
+
+rm -f src/spek
+
+sed 's/ --host=.*"/"/' "$HOMEBREW_PREFIX"/share/wx/*/aclocal/wxwin.m4 > wxwin.m4
+echo "m4_include([wxwin.m4])" > acinclude.m4
+
+./autogen.sh CC='clang -arch arm64' CXX='clang++ -arch arm64' --host=arm64-apple-darwin && make -j2 || exit 1
+
+cd dist/osx
+rm -fr Spek.app
+mkdir -p Spek.app/Contents/MacOS
+mkdir -p Spek.app/Contents/Frameworks
+mkdir -p Spek.app/Contents/Resources
+mv ../../src/spek Spek.app/Contents/MacOS/Spek
+cp Info.plist Spek.app/Contents/
+cp Spek.icns Spek.app/Contents/Resources/
+cp *.png Spek.app/Contents/Resources/
+cp ../../LICENCE.md Spek.app/Contents/Resources/
+cp ../../README.md Spek.app/Contents/Resources/
+mkdir Spek.app/Contents/Resources/lic
+cp ../../lic/* Spek.app/Contents/Resources/lic/
+
+for lang in $LANGUAGES; do
+    mkdir -p Spek.app/Contents/Resources/"$lang".lproj
+    cp -v ../../po/"$lang".gmo Spek.app/Contents/Resources/"$lang".lproj/spek.mo
+    cp -v "$LOCALEDIR""$lang"/LC_MESSAGES/wxstd*.mo Spek.app/Contents/Resources/"$lang".lproj/wxstd.mo
+done
+mkdir -p Spek.app/Contents/Resources/en.lproj
+
+BINS="Spek.app/Contents/MacOS/Spek"
+while [ ! -z "$BINS" ]; do
+    NEWBINS=""
+    for bin in $BINS; do
+        echo "Updating dependendies for $bin."
+        LIBS=$(otool -L $bin | grep -e /usr/local/ -e /opt/ | tr -d '\t' | awk '{print $1}')
+        for lib in $LIBS; do
+            reallib=$(realpath $lib)
+            libname=$(basename $reallib)
+            install_name_tool -change $lib @executable_path/../Frameworks/$libname $bin
+            if [ ! -f Spek.app/Contents/Frameworks/$libname ]; then
+                echo "\tBundling $reallib."
+                cp $reallib Spek.app/Contents/Frameworks/
+                chmod +w Spek.app/Contents/Frameworks/$libname
+                install_name_tool -id @executable_path/../Frameworks/$libname Spek.app/Contents/Frameworks/$libname
+                NEWBINS="$NEWBINS Spek.app/Contents/Frameworks/$libname"
+            fi
+        done
+    done
+    BINS="$NEWBINS"
+done
+
+# Sign the app
+codesign -fs - ./Spek.app ./Spek.app/Contents/Frameworks/*
+
+# Create a gzip tar archive
+rm -f Spek.tgz
+tar cvzf Spek.tgz ./Spek.app
+
+# Clean up
+cd ../..
+rm wxwin.m4 acinclude.m4
diff --git a/dist/osx/cross/install_deps.sh b/dist/osx/cross/install_deps.sh
new file mode 100755
index 0000000..35d625d
--- /dev/null
+++ b/dist/osx/cross/install_deps.sh
@@ -0,0 +1,79 @@
+#!/bin/bash
+
+if [ "$1" != "i_am_ci" ]
+then
+    cat << EOF
+
+!!! DO NOT RUN THIS SCRIPT ON YOUR COMPUTER !!!
+-----------------------------------------------
+This script is used to build Spek-X Apple Silicon packages on Intel macOS CI.
+It will break your dependencies if not executed in a container.
+
+EOF
+    exit 1
+fi
+
+FFMPEG_VER="5.1.2"
+PREFIX="/usr/local"
+
+# Check Homebrew
+brew --version >/dev/null 2>&1 || {
+    echo "Building spek.app requires Homebrew. Follow the instructions at [https://brew.sh] to install Homebrew."
+    exit 1
+}
+
+brew install autoconf automake gettext intltool libtool pkg-config wxwidgets nasm wget coreutils || exit 1
+# Force install arm64 libraries on x86_64 machines
+for dep in jpeg-turbo libpng zstd libtiff pcre2 wxwidgets
+do
+    brew reinstall $(brew fetch --force --bottle-tag=arm64_monterey "${dep}" | egrep -om1 '/Users/.*\.gz') || return 1
+done
+
+rm -rf $(dirname $0)/../deps
+mkdir -p $(dirname $0)/../deps
+cd $(dirname $0)/../deps
+
+# === FFmpeg ===
+echo "# Installing FFmpeg..."
+brew unlink ffmpeg
+wget "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VER}.tar.bz2" || exit 1
+tar xjvf "ffmpeg-${FFMPEG_VER}.tar.bz2"
+cd "ffmpeg-${FFMPEG_VER}"
+./configure \
+    --enable-cross-compile \
+    --arch=arm64 \
+    --cc='clang -arch arm64' \
+    --prefix="$PREFIX" \
+    --enable-version3 \
+    --enable-gpl \
+    --disable-programs \
+    --disable-doc \
+    --disable-debug \
+    --enable-static \
+    --disable-shared \
+    --enable-pic \
+    --disable-swscale \
+    --disable-postproc \
+    --disable-avfilter \
+    --disable-avdevice \
+    --disable-network \
+    --disable-xlib \
+    --disable-encoders \
+    --disable-hwaccels \
+    --disable-muxers \
+    --disable-bsfs \
+    --disable-devices \
+    --disable-filters \
+    --disable-protocols \
+    --enable-protocol=file,pipe \
+    --disable-parsers \
+    --enable-parser=aac,aac_latm,ac3,cook,dca,dirac,dolby_e,flac,g723_1,g729,gsm,mlp,mpegaudio,opus,sbc,sipr,tak,vorbis\
+    --disable-decoders \
+    --enable-decoder=aac,aac_fixed,aac_latm,ac3,ac3_fixed,acelp_kelvin,alac,als,amrnb,amrwb,ape,aptx,aptx_hd,atrac1,atrac3,atrac3al,atrac3p,atrac3pal,atrac9,binkaudio_dct,binkaudio_rdft,bmv_audio,cook,dca,dfpwm,dolby_e,dsd_lsbf,dsd_msbf,dsd_lsbf_planar,dsd_msbf_planar,dsicinaudio,dss_sp,dst,eac3,evrc,fastaudio,ffwavesynth,flac,g723_1,g729,gsm,gsm_ms,hca,hcom,iac,ilbc,imc,interplay_acm,mace3,mace6,metasound,mlp,mp1,mp1float,mp2,mp2float,mp3float,mp3,mp3adufloat,mp3adu,mp3on4float,mp3on4,mpc7,mpc8,msnsiren,nellymoser,on2avc,opus,paf_audio,qcelp,qdm2,qdmc,ra_144,ra_288,ralf,sbc,shorten,sipr,siren,smackaud,sonic,tak,truehd,truespeech,tta,twinvq,vmdaudio,vorbis,wavpack,wmalossless,wmapro,wmav1,wmav2,wmavoice,ws_snd1,xma1,xma2,pcm_alaw,pcm_bluray,pcm_dvd,pcm_f16le,pcm_f24le,pcm_f32be,pcm_f32le,pcm_f64be,pcm_f64le,pcm_lxf,pcm_mulaw,pcm_s8,pcm_s8_planar,pcm_s16be,pcm_s16be_planar,pcm_s16le,pcm_s16le_planar,pcm_s24be,pcm_s24daud,pcm_s24le,pcm_s24le_planar,pcm_s32be,pcm_s32le,pcm_s32le_planar,pcm_s64be,pcm_s64le,pcm_sga,pcm_u8,pcm_u16be,pcm_u16le,pcm_u24be,pcm_u24le,pcm_u32be,pcm_u32le,pcm_vidc,derf_dpcm,gremlin_dpcm,interplay_dpcm,roq_dpcm,sdx2_dpcm,sol_dpcm,xan_dpcm,adpcm_4xm,adpcm_adx,adpcm_afc,adpcm_agm,adpcm_aica,adpcm_argo,adpcm_ct,adpcm_dtk,adpcm_ea,adpcm_ea_maxis_xa,adpcm_ea_r1,adpcm_ea_r2,adpcm_ea_r3,adpcm_ea_xas,adpcm_g722,adpcm_g726,adpcm_g726le,adpcm_ima_acorn,adpcm_ima_amv,adpcm_ima_alp,adpcm_ima_apc,adpcm_ima_apm,adpcm_ima_cunning,adpcm_ima_dat4,adpcm_ima_dk3,adpcm_ima_dk4,adpcm_ima_ea_eacs,adpcm_ima_ea_sead,adpcm_ima_iss,adpcm_ima_moflex,adpcm_ima_mtf,adpcm_ima_oki,adpcm_ima_qt,adpcm_ima_rad,adpcm_ima_ssi,adpcm_ima_smjpeg,adpcm_ima_wav,adpcm_ima_ws,adpcm_ms,adpcm_mtaf,adpcm_psx,adpcm_sbpro_2,adpcm_sbpro_3,adpcm_sbpro_4,adpcm_swf,adpcm_thp,adpcm_thp_le,adpcm_vima,adpcm_xa,adpcm_yamaha,adpcm_zork || exit 1
+make -j3 || exit 1
+echo "$ sudo make install # your password may be necessary"
+sudo make install || exit 1
+
+# Clean up
+cd ../..
+rm -rf ./deps
